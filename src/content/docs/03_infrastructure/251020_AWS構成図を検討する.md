---
title: AWS構成図を検討する
---

# RDB のデプロイ方法

# API サーバのデプロイ方法

- ECS 上にデプロイ（with ALB）
- ECS 上にデプロイ（with API Gateway）
- Lambda 上にデプロイ（with ALB）
- Lambda 上にデプロイ（with API Gateway）
- App Runner を利用（Lambda + ALB のマネージドサービス）

## どちらを使うか迷うポイント: ALB or API Gateway？

AWS では、「インターネットからの入り口」（Inbound 通信）を**ALB**や**API Gateway**が担う

※ALB / API Gateway は VPC の外にある。しかし、VPC の中のサービス（ECS や RDS など）には安全に繋げる（セキュアなプライベート接続）。これを VPC Link という

- アクセスが少ないアプリ → API Gateway が安い（**リクエスト数に応じた課金**のため）
- 常時動く Web アプリ → ALB の方がコスパ良い（**稼働時間・データ転送量に応じた課金**のため）

## どちらを使うか迷うポイント: NAT Gateway or VPC エンドポイント？

AWS では、「インターネットへの入り口」（Outbound 通信）を**NAT Gateway**が担う

- NAT Gateway: 外部インターネット通信の出口 **コスト高め（月 1,000〜3,000 円）**

AWS 内サービス間通信には、VPC エンドポイントを使う。

- VPC エンドポイント: AWS 内サービス専用通信 **安価（数十円〜数百円/月）**

# 各サービスの詳細

## ネットワーク関連

### VPC（Virtual Private Cloud）

- AWS 上に自分専用の仮想ネットワーク空間を作るサービス
- VPC の中には、**サブネット**（VPC 内のネットワークの小分けゾーン）を作成することができて、何をどこに置くか決めることができる
- **パブリックサブネット**: 外部（インターネット）と通信できるサブネット

  - Internet Gateway（IGW）へのルートがある
  - 配下の EC2 や ALB が パブリック IP を持てる
  - インターネットからアクセスを受け付けられる
  - 使用例: 外部公開用の ALB や踏み台サーバ（Bastion）を置く

- **プライベートサブネット**: 外部（インターネット）と直接通信できないサブネット

  - Internet Gateway へのルートがない
  - インターネットに直接出られない
  - 代わりに、NAT Gateway 経由で Outbound 通信（サーバ → インターネット）のみ可能
  - 外部から直接アクセスされることはない（セキュア）

```css
┌─────────────────────────────────────────────────────┐
│              VPC（自分専用ネットワーク）              │
│                                                     │
│      ┌─────────────────┬──────────────────┐         │
│      │    サブネットA   │    サブネットB    │         │
│      │ (例: パブリック) │ (例: プライベート) │         │
│      └─────────────────┴──────────────────┘         │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Internet Gateway（IGW）

- VPC を**インターネットにつなぐためのゲート（出入口）**
- VPC の中にある「パブリック IP 付きリソース」に外部からアクセスできるようにする
- VPC 内の EC2 などが外のインターネットに出ていく通信を許可する
- IGW をアタッチしていない VPC は、完全に閉じた空間
- IGW をアタッチしても、ルートテーブルに設定しなければ通信は通らない

## 窓口関連

### API Gateway

- マッピングテンプレートを使うことで、JSON ↔ XML 変換が可能
- API を外部に公開する場合はこれを使う

#### 補足 API Gateway の「統合（Integration）」とは？

- **API Gateway がリクエストをどのようにバックエンドへ渡すか**を定義する仕組みのことである。
- まとめ表

| 統合タイプ                          | バックエンドの種類                    | ペイロード変換(VTL)                   | VPC Link 利用               | 主な用途                                        |
| ----------------------------------- | ------------------------------------- | ------------------------------------- | --------------------------- | ----------------------------------------------- |
| **HTTP カスタム統合**               | HTTP/HTTPS エンドポイント（VPC 内外） | ✅ 可能（マッピングテンプレート使用） | ✅ 可能                     | JSON→XML など、変換が必要な REST 連携           |
| **HTTP プロキシ統合**               | HTTP/HTTPS エンドポイント（VPC 内外） | ❌ 不可（パススルー）                 | ✅ 可能                     | 単純な透過転送（変換不要）                      |
| **Lambda 統合（非プロキシ）**       | AWS Lambda 関数                       | ✅ 可能（マッピングテンプレート使用） | ❌ 不要                     | JSON 構造を変換して Lambda に渡す               |
| **Lambda プロキシ統合 (AWS_PROXY)** | AWS Lambda 関数                       | ❌ 不可（Lambda で処理）              | ❌ 不要                     | リクエスト内容をそのまま渡す（Lambda 内で処理） |
| **ALB 統合**                        | Application Load Balancer             | ❌ 不可（パススルー）                 | ✅ 可能（Private ALB のみ） | VPC 内の ALB 配下サービスへルーティング         |

- まとめ表補足: HTTP/HTTPS エンドポイントとは？

  → 具体的には、

  - 外部の Web API
  - ECS や EKS などのコンテナアプリ（VPC 内部のプライベートな HTTP エンドポイント）
  - EC2 上の FastAPI

  などが当てはまる。

- まとめ表補足: ペイロードとは？

  → ペイロード = リクエストやレスポンスの“中身のデータ”のこと（例: JSON）

  - ペイロード変換とは？

    → API Gateway で、受け取ったデータの形式や構造を変換すること（例: JSON → XML）

  - VTL（Velocity Template Language）とは？

    → API Gateway 内で JSON/XML を自由に組み替える魔法のテンプレート言語

1. HTTP カスタム統合（非プロキシ）

- 双方向変換が可能（VTL テンプレート使用）
- VPC 内リソースにも接続可能（VPC Link 使用）

```txt
Client
  ↓ JSON
API Gateway
  ↓ (VTLで変換 JSON→XML)
VPC Link
  ↓
Backend (HTTP endpoint, XML expected)
  ↓ (XML Response)
API Gateway
  ↓ (VTLで変換 XML→JSON)
Client
```

2. HTTP プロキシ統合

- 変換なし
- 「API Gateway は中継役だけ」という構成

```txt
Client
  ↓ JSON
API Gateway
  ↓（パススルー、変換なし）
VPC Link
  ↓
Backend (HTTP endpoint)
```

3. Lambda プロキシ統合 (AWS_PROXY)

- 柔軟だが、Lambda で全処理を自分で実装する必要あり
- VPC 内 HTTP エンドポイントを直接呼ぶ用途ではない

```txt
Client
  ↓ JSON
API Gateway
  ↓（そのまま渡す）
Lambda Function
  ↓（Lambda内でJSON/XML変換などを実施）
```

4. ALB 統合

- 変換不可
- ステージ変数では「宛先変更」はできても「内容変換」はできない

```txt
Client
  ↓
API Gateway
  ↓
VPC Link
  ↓
Private ALB → Backend Service
```

### ALB（）

- プライベート ALB: VPC 内負荷分散をしたい時にはこれを使う
- パブリック ALB:
- 外部 API が不要なマイクロサービスにはこれを使う

## インスタンス関連

## EC2
